name: Build and Push n8n Enterprise Docker Image

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: mroplus/n8n
  IMAGE_TAG: enterprise

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4

    - name: Clone n8n repository
      run: |
        git clone https://github.com/n8n-io/n8n.git n8n-source
        cd n8n-source
        git fetch --tags

        releases_json=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases)
        latest_stable_tag=$(echo "$releases_json" | jq -r '.[] | select(.prerelease == false) | .tag_name' | head -n 1)
        if [ -n "$latest_stable_tag" ]; then
          git checkout "$latest_stable_tag"
        fi

        n8n_commit_hash=$(git rev-parse HEAD)
        echo "Cloned n8n repository successfully"
        echo "Current commit: $n8n_commit_hash"
        echo "N8N_COMMIT_HASH=$n8n_commit_hash" >> $GITHUB_ENV

    - name: Copy bypass script to n8n repository
      run: |
        if [ -f "bypass.sh" ]; then
          cp bypass.sh n8n-source/
          echo "bypass.sh copied to n8n-source directory"
        else
          echo "bypass.sh not found in current repository"
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('n8n-source/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Install dependencies
      run: |
        cd n8n-source
        pnpm install --frozen-lockfile

    - name: Run bypass script
      run: |
        cd n8n-source
        if [ -f "bypass.sh" ]; then
          chmod +x bypass.sh
          ./bypass.sh --auto
          echo "bypass.sh executed successfully with --auto mode"
        else
          echo "bypass.sh not found in n8n repository, skipping..."
        fi

    - name: Build n8n
      run: |
        cd n8n-source
        pnpm run build

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/amd64,linux/arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Find Dockerfile
      run: |
        cd n8n-source
        if [ -f "docker/images/n8n/Dockerfile" ]; then
          echo "DOCKERFILE_PATH=docker/images/n8n/Dockerfile" >> $GITHUB_ENV
          echo "DOCKER_CONTEXT=." >> $GITHUB_ENV
        elif [ -f "Dockerfile" ]; then
          echo "DOCKERFILE_PATH=Dockerfile" >> $GITHUB_ENV
          echo "DOCKER_CONTEXT=." >> $GITHUB_ENV
        else
          echo "Error: Could not find Dockerfile"
          find . -name "Dockerfile" -type f
          exit 1
        fi

    - name: Build and push multi-architecture Docker image
      run: |
        cd n8n-source
        
        # Get the current n8n commit hash
        N8N_COMMIT=$(git rev-parse HEAD)
        echo "N8N Commit: $N8N_COMMIT"
        
        # Find the correct Dockerfile path
        if [ -f "docker/images/n8n/Dockerfile" ]; then
          DOCKERFILE_PATH="docker/images/n8n/Dockerfile"
        elif [ -f "Dockerfile" ]; then
          DOCKERFILE_PATH="Dockerfile"
        else
          echo "Error: Could not find Dockerfile"
          find . -name "Dockerfile" -type f
          exit 1
        fi
        
        echo "Using Dockerfile: $DOCKERFILE_PATH"
        
        # Build and push multi-architecture image
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --file "$DOCKERFILE_PATH" \
          --tag "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          --tag "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" \
          --tag "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
          --tag "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:n8n-${N8N_COMMIT}" \
          --label "org.opencontainers.image.title=n8n Enterprise" \
          --label "org.opencontainers.image.description=n8n Enterprise Docker Image" \
          --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
          --label "org.opencontainers.image.revision=${{ github.sha }}" \
          --label "n8n.commit.hash=${N8N_COMMIT}" \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          --push \
          .
        
        echo "Successfully pushed multi-architecture Docker image to GHCR"

    - name: Clean up
      if: always()
      run: |
        docker system prune -f
